<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
  <div class="w-full max-w-md p-6 bg-gray-800 rounded-2xl shadow-xl">
    <h2 class="text-2xl font-bold text-center mb-4">ğŸ’° Withdraw Saldo</h2>
    <p id="saldo" class="text-lg text-center mb-4">Saldo: Rp0</p>
    <div id="statusUser" class="text-red-400 text-center mb-4 hidden"></div>

    <!-- Form WD -->
    <form id="formWD" class="space-y-3">
      <input type="number" id="nominal" class="w-full p-3 rounded-lg text-black" placeholder="Nominal WD (min Rp30.000)" required />
      
      <select id="ewallet" class="w-full p-3 rounded-lg text-black" required>
        <option value="">Pilih E-Wallet</option>
        <option value="Dana">Dana</option>
        <option value="OVO">OVO</option>
        <option value="Gopay">Gopay</option>
        <option value="ShopeePay">ShopeePay</option>
        <option value="Bank">Bank</option>
      </select>

      <input type="text" id="number" class="w-full p-3 rounded-lg text-black" placeholder="Nomor E-Wallet / Rekening" required />

      <button type="submit" id="btnWD" class="w-full bg-green-500 hover:bg-green-600 p-3 rounded-lg font-bold">
        Ajukan WD
      </button>
    </form>

    <!-- Riwayat -->
    <h3 class="text-xl font-semibold mt-6 mb-2">ğŸ“œ Riwayat WD</h3>
    <ul id="riwayatWD" class="space-y-2 text-sm"></ul>
  </div>

  <!-- Loading -->
  <div id="loading" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 text-white text-lg font-bold">
    â³ Loading...
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, push, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.appspot.com",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const saldoEl = document.getElementById("saldo");
    const formWD = document.getElementById("formWD");
    const riwayatWD = document.getElementById("riwayatWD");
    const statusUser = document.getElementById("statusUser");
    const btnWD = document.getElementById("btnWD");
    const loading = document.getElementById("loading");

    let currentSaldo = 0;
    let userStatus = "active";

    // ğŸ”‘ Cek login user
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const uid = user.uid;
        const userRef = ref(db, `users/${uid}`);

        // realtime user data
        onValue(userRef, (snap) => {
          if (snap.exists()) {
            const data = snap.val();
            currentSaldo = data.saldo || 0;
            userStatus = data.status || "active";

            saldoEl.innerText = "Saldo: Rp" + currentSaldo.toLocaleString();

            // jika banned
            if (userStatus === "banned") {
              statusUser.innerText = "âš ï¸ Akun Anda diblokir, hubungi admin!";
              statusUser.classList.remove("hidden");
              btnWD.disabled = true;
              btnWD.classList.add("bg-gray-500");
            } else {
              statusUser.classList.add("hidden");
              btnWD.disabled = false;
              btnWD.classList.remove("bg-gray-500");
            }
          }
        });

        // load riwayat WD user
        const wdRef = ref(db, "withdrawals");
        onValue(wdRef, (snap) => {
          riwayatWD.innerHTML = "";
          snap.forEach((child) => {
            if (child.val().uid === uid) {
              let li = document.createElement("li");
              li.textContent = `Rp${child.val().nominal} - ${child.val().ewallet} - ${child.val().status}`;
              riwayatWD.appendChild(li);
            }
          });
        });
      } else {
        alert("Silakan login dulu!");
        window.location.href = "login.html";
      }
    });

    // ğŸ¦ Ajukan WD
    formWD.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const uid = user.uid;
      const nominal = parseInt(document.getElementById("nominal").value);
      const ewallet = document.getElementById("ewallet").value;
      const number = document.getElementById("number").value;

      if (userStatus === "banned") {
        alert("Akun diblokir, hubungi admin!");
        return;
      }
      if (nominal < 30000) {
        alert("Minimal WD Rp30.000");
        return;
      }
      if (currentSaldo < nominal) {
        alert("Saldo tidak cukup!");
        return;
      }

      loading.classList.remove("hidden"); // show loading

      const wdRef = push(ref(db, "withdrawals"));
      await set(wdRef, {
        uid,
        nominal,
        ewallet,
        number,
        status: "pending",
        timestamp: Date.now()
      });

      // update saldo user
      await update(ref(db, `users/${uid}`), {
        saldo: currentSaldo - nominal
      });

      loading.classList.add("hidden"); // hide loading
      alert("âœ… WD berhasil diajukan, menunggu admin!");
      formWD.reset();
    });
  </script>
</body>
