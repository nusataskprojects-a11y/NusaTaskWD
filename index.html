<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NusaTask ‚Ä¢ Withdraw</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;background:#0b0f17;color:#e8ecf1}
  .wrap{max-width:560px;margin:24px auto;padding:16px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .title{font-weight:700;font-size:22px;margin:0 0 4px}
  .muted{color:#9ca3af;font-size:13px;margin:0 0 16px}
  .saldo{font-size:18px;margin:8px 0 16px}
  .row{display:grid;gap:10px}
  input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0f172a;color:#e5e7eb;outline:none}
  input::placeholder{color:#6b7280}
  select{appearance:none}
  button{cursor:pointer;background:#16a34a;border:none;font-weight:700;transition:.2s}
  button:hover{filter:brightness(1.05)}
  button[disabled]{background:#3f3f46;cursor:not-allowed;opacity:.7}
  .list{margin:12px 0 0;display:grid;gap:8px}
  .item{background:#0f172a;border:1px solid #1f2937;padding:12px;border-radius:12px;font-size:14px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .status{font-weight:700}
  .pending{color:#fbbf24}.approved{color:#22c55e}.rejected{color:#ef4444}
  .warn{background:#281a1a;border:1px solid #7f1d1d;color:#fecaca;padding:10px 12px;border-radius:10px;margin:-4px 0 12px;font-size:13px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111827;border:1px solid #334155;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.25s}
  .toast.show{opacity:1;pointer-events:auto}
  .loader{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
  .spinner{width:44px;height:44px;border-radius:999px;border:4px solid #334155;border-top-color:#60a5fa;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{background:#0f172a;border:1px solid #334155;color:#93c5fd;font-size:12px;padding:4px 8px;border-radius:999px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div style="width:32px;height:32px;border-radius:10px;background:#0f172a;border:1px solid #334155;display:grid;place-items:center">üí∞</div>
        <div>
          <div class="title">Withdraw Saldo</div>
          <p class="muted">Tarik penghasilanmu ke e-wallet (min Rp30.000)</p>
        </div>
        <div style="margin-left:auto" class="badge">NusaTask</div>
      </div>

      <p id="saldo" class="saldo">Saldo: Rp0</p>
      <div id="banNote" class="warn" style="display:none">‚ö†Ô∏è Akun kamu diblokir. Hubungi admin @nusataskproject</div>

      <!-- FORM WD -->
      <form id="formWD" class="row" autocomplete="off">
        <input type="number" id="nominal" placeholder="Nominal WD (min Rp30.000)" min="30000" required />
        <select id="ewallet" required>
          <option value="">Pilih E-Wallet</option>
          <option value="Dana">Dana</option>
          <option value="OVO">OVO</option>
          <option value="Gopay">Gopay</option>
          <option value="ShopeePay">ShopeePay</option>
          <option value="Bank">Bank</option>
        </select>
        <input type="text" id="number" placeholder="Nomor e-wallet / rekening" required />
        <button id="btnWD" type="submit">Ajukan WD</button>
      </form>

      <h3 style="margin:18px 0 8px;font-size:16px">üìú Riwayat WD</h3>
      <div id="empty" class="muted">Belum ada riwayat.</div>
      <div id="riwayat" class="list"></div>
    </div>
  </div>

  <!-- LOADER -->
  <div id="loader" class="loader"><div class="spinner"></div></div>
  <!-- TOAST -->
  <div id="toast" class="toast">Pesan</div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // ==== CONFIG (punyamu) ====
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.appspot.com",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };

    // ==== INIT ====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ==== UI helpers ====
    const $ = (s)=>document.querySelector(s);
    const saldoEl = $("#saldo");
    const banNote = $("#banNote");
    const formWD = $("#formWD");
    const btnWD = $("#btnWD");
    const riwayatWrap = $("#riwayat");
    const empty = $("#empty");
    const loader = $("#loader");
    const toast = $("#toast");
    let currentSaldo = 0;
    let userStatus = "active";
    let uid = null;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }
    function setLoading(v){ loader.style.display = v ? "flex" : "none"; }

    // ==== AUTH ====
    onAuthStateChanged(auth, user=>{
      if(!user){
        showToast("Silakan login dulu.");
        // arahkan ke halaman login milikmu
        location.replace("login.html");
        return;
      }
      uid = user.uid;

      // saldo realtime
      onValue(ref(db, `users/${uid}`), (snap)=>{
        const data = snap.val() || {};
        currentSaldo = Number(data.saldo || 0);
        userStatus = data.status || "active";
        saldoEl.textContent = "Saldo: Rp" + currentSaldo.toLocaleString();

        if(userStatus === "banned"){
          banNote.style.display = "block";
          btnWD.disabled = true;
        }else{
          banNote.style.display = "none";
          btnWD.disabled = false;
        }
      });

      // riwayat WD user
      onValue(ref(db, "withdrawals"), (snap)=>{
        riwayatWrap.innerHTML = "";
        let count = 0;
        snap.forEach(ch=>{
          const wd = ch.val();
          if(wd.uid === uid){
            count++;
            const div = document.createElement("div");
            div.className = "item";
            const st = wd.status || "pending";
            div.innerHTML = `
              <div>Rp${Number(wd.nominal).toLocaleString()} ‚Ä¢ ${wd.ewallet} ‚Ä¢ ${wd.number}</div>
              <div class="status ${st}">${st}</div>
            `;
            riwayatWrap.prepend(div);
          }
        });
        empty.style.display = count ? "none":"block";
      });
    });

    // ==== AJUKAN WD ====
    formWD.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!uid) return;

      const nominal = Number($("#nominal").value);
      const ewallet = $("#ewallet").value.trim();
      const number  = $("#number").value.trim();

      if(userStatus === "banned"){ showToast("Akun diblokir."); return; }
      if(!ewallet || !number || !nominal){ showToast("Lengkapi data WD."); return; }
      if(nominal < 30000){ showToast("Minimal WD Rp30.000."); return; }

      setLoading(true);
      btnWD.disabled = true;

      try{
        // Transaksi aman: cek saldo & kurangi atomically
        const userRef = ref(db, `users/${uid}/saldo`);
        const ok = await runTransaction(userRef, (saldo)=>{
          saldo = Number(saldo || 0);
          if(saldo >= nominal) return saldo - nominal;
          return; // abort
        });

        if(!ok.committed){
          showToast("Saldo tidak cukup.");
          btnWD.disabled = false;
          setLoading(false);
          return;
        }

        // Tulis WD baru
        const wdRef = push(ref(db, "withdrawals"));
        await set(wdRef, {
          uid,
          nominal,
          ewallet,
          number,
          status: "pending",
          timestamp: Date.now()
        });

        formWD.reset();
        showToast("WD diajukan. Menunggu admin.");
      }catch(err){
        console.error(err);
        showToast("Gagal mengajukan WD.");
      }finally{
        setLoading(false);
        btnWD.disabled = false;
      }
    });
  </script>
</body>
</html>
