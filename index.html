<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>NusaTask - Withdraw</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white; font-family: "Poppins", sans-serif; text-align: center;
      margin: 0; padding: 0;
    }
    .container { padding: 20px; }
    .card {
      background: rgba(255,255,255,0.08);
      padding: 20px; margin: 20px auto; border-radius: 15px;
      max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
      animation: fadeIn 0.8s ease-in-out;
    }
    h2 { margin-bottom: 10px; }
    input, select, button {
      width: 90%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px;
      font-size: 14px;
    }
    input, select {
      background: rgba(255,255,255,0.1); color: white;
    }
    input::placeholder { color: #aaa; }
    button {
      background: #00c853; color: white; font-weight: bold; cursor: pointer;
      transition: 0.3s; font-size: 15px;
    }
    button:hover { background: #009624; transform: scale(1.05); }
    ul { text-align: left; padding: 0; }
    li {
      list-style: none; padding: 8px; margin: 5px 0;
      background: rgba(0,0,0,0.3); border-radius: 8px;
      animation: slideIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>💰 Withdraw Saldo</h2>
      <p>Total Saldo: <span id="saldoTotal">Rp0</span></p>

      <select id="method">
        <option value="Dana">Dana</option>
        <option value="OVO">OVO</option>
        <option value="Gopay">Gopay</option>
        <option value="ShopeePay">ShopeePay</option>
        <option value="Bank">Bank Transfer</option>
      </select>

      <input type="text" id="account" placeholder="Nomor Dana/Bank">
      <input type="number" id="amount" placeholder="Minimal Rp30.000">

      <button onclick="requestWD()">Ajukan WD</button>
    </div>

    <div class="card">
      <h2>📜 Riwayat WD</h2>
      <ul id="riwayatWD"><li>Belum ada data</li></ul>
    </div>
  </div>

<script>
  // 🔥 Firebase Config (punya kamu)
  const firebaseConfig = {
    apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
    authDomain: "penyimpanansaldo-280df.firebaseapp.com",
    databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "penyimpanansaldo-280df",
    storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
    messagingSenderId: "659609775130",
    appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
    measurementId: "G-L4TW7E23H2"
  };
  firebase.initializeApp(firebaseConfig);

  const db = firebase.database();
  const userId = "UID_USER_AKTIF"; // nanti diambil dari login auth

  // 🔄 Hitung saldo gabungan
  function loadSaldo() {
    db.ref("users/" + userId).on("value", snap => {
      const d = snap.val() || {};
      let total = (d.saldoBot1||0)+(d.saldoBot2||0)+(d.saldoBot3||0)+(d.saldoBot4||0)+(d.saldoBot5||0);
      db.ref("users/" + userId + "/totalSaldo").set(total);
      document.getElementById("saldoTotal").innerText = "Rp" + total.toLocaleString();
    });
  }

  // 🚀 Ajukan WD
  function requestWD() {
    const method = document.getElementById("method").value;
    const account = document.getElementById("account").value.trim();
    const amount = parseInt(document.getElementById("amount").value);

    if(!account) {
      Swal.fire("❌ Gagal", "Nomor akun wajib diisi", "error");
      return;
    }

    db.ref("users/" + userId).once("value").then(snapshot => {
      let data = snapshot.val() || {};
      let total = data.totalSaldo || 0;

      if(amount < 30000) {
        Swal.fire("⚠️ Minimal WD Rp30.000", "", "warning");
        return;
      }
      if(amount > total) {
        Swal.fire("❌ Saldo tidak cukup", "", "error");
        return;
      }

      // potong saldo
      db.ref("users/" + userId + "/totalSaldo").set(total - amount);

      // buat record WD
      const wdId = db.ref().child("withdrawals").push().key;
      db.ref("withdrawals/" + wdId).set({
        userId: userId,
        amount: amount,
        method: method,
        account: account,
        createdAt: Date.now(),
        status: "pending"
      });

      Swal.fire({
        icon: "success",
        title: "✅ WD berhasil diajukan",
        text: "Tunggu diproses admin",
        showConfirmButton: false,
        timer: 2000
      });
    });
  }

  // 📜 Riwayat WD user
  function loadRiwayat() {
    db.ref("withdrawals").orderByChild("userId").equalTo(userId).on("value", snap => {
      const data = snap.val();
      const ul = document.getElementById("riwayatWD");
      ul.innerHTML = "";
      if(!data) { ul.innerHTML = "<li>Belum ada data</li>"; return; }

      Object.keys(data).reverse().forEach(id => {
        let wd = data[id];
        let statusColor = wd.status === "success" ? "lime" : (wd.status === "rejected" ? "red" : "orange");
        ul.innerHTML += `<li>
          Rp${wd.amount} - ${wd.method} (${wd.status})
          <br><small style="color:${statusColor}">Status: ${wd.status}</small>
        </li>`;
      });
    });
  }

  loadSaldo();
  loadRiwayat();
</script>
</body>
</html>
